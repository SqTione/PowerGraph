# Документация проекта Power Graph

***

## Содержание

1. [Описание проекта](#описание-проекта)
2. [Используемые технологии](#используемые-технологии)
3. [Развертывание проекта](#развертывание-проекта)
4. [Алгоритм прореживания данных](#алгоритм-прореживания-данных)
5. [Команды](#команды)
6. [Проблемы](#проблемы)

## Описание проекта

Данный проект предназначен для удобного отслеживания мгновенных показателей со счётчиков по фазам A, B и C. \
Проект разработан в рамках производственной практики для "ООО Технологии энергоучёта".

## Используемые технологии

В процессе работы над данным проектом использовались следующие технологии:

1. PHP 7.4 FPM
2. Фреймворк Yii 1.1
3. Веб сервер Nginx alpine
4. СУБД MySQL 5.7
5. Очереди RabbitMQ 3
6. JavaScript + JQuery
7. Библиотека для отрисовки графиков Chart.js
8. Docker + Docker Compose
9. Git Hub + Git Flow

## Структура проекта:

Репозиторий имеет 2 основных каталога ```docker``` и ```src```.
Каталог ```docker``` содержит настройки веб-сервера Nginx, Dockerfile, а также команды crontab.

```
docker/
├── nginx/
│   └── default.conf
│   php/
│   └── Dockerfile
└── crontab
```

Каталог ```src``` содержит основную часть проекта, которая монтируется в контейнер ```power_graph_app```. \
Основные подкаталоги ```src```:

* ```css``` содержит стили CSS стили веб-приложения
* ```fonts``` содержит используемые шрифты
* ```images``` содержит графику, используемую в веб-приложении
* ```protected``` каталог с логикой приложения:
    * ```commands``` [команды](#команды), которые можно вызвать в из терминала
    * ```components``` вспомогательные классы
    * ```config``` конфиги проекта
    * ```controllers``` контроллеры
    * ```extensions``` frontend библиотеки
    * ```migations``` миграции
    * ```models``` модели данных
    * ```runtime``` логи
    * ```services``` сервисы
    * ```test``` тесты
    * ```views``` представления страниц
* ```vendor``` библиотеки composer

```
src/
├── css/
├── fonts/
├── images/
├── protected/
│   ├── commands/
│   ├── components/
│   ├── config/
│   ├── controllers/
│   ├── extensions/
│   ├── migrations/
│   ├── models/
│   ├── runtime/
│   ├── services/
│   ├── test/
│   └── views/
└── vendor/
```

В корне репозитория находятся файлы:

* ```dockercompose``` настройка контейнеров
* ```dump.sql``` дамп базы данных
* ```README.md``` документация проекта

## Развертывание проекта

Чтобы развернуть проект, необходимо установить Docker Compose на компьютер и скачать репозиторий. \
В корне репозитория ввести команду:

```
docker-compose up --build -d
```

После чего основное приложение будет доступно по адресу ```http://localhost:8080```. \
Но для правильной работы необходимо выполнить миграции, либо импортировать дамп БД. \

1) Выполнение миграций:

```
# Войдите в контейнер power_graph_app:
docker-compose exec app bash

# Введите команду для выполнения миграций
./protected/yiic migrate
```

2) Импорт дампа базы данных: \
   Вам потребуется ввести данные аккаунта \
   Стандартные установлены следующие:\
   Пользователь: user user_password \
   Администратор: root root

```
# Скопируйте дамб в контейнер:
docker cp dump.sql power_graph_db:/tmp/dump.sql

# Войдите в контейнер power_graph_db:
docker-compose exec db bash

# Введите команду для импорта дампа:
mysql -u <имя_пользователя> -p power_graph_db < dump.sql
```

Теперь в фоновом режиме начнут получаться новые данные со счётчиков.

# Алгоритм прореживания данных

В проекте реализован алгоритм прореживания данных, который берет старые данные(в проекте старше 1 недели), вычисляет
аномальные значения и заносят в архивную таблицу ```thinned_voltage_data``` вместе с соседними значениями и удаляет
старые данные из основной таблицы. \
Алгоритм основан на поиске величин, имеющих наибольшее отклонение от линейной регрессии. С предусмотренной возможностью
замены стратегии поиска величин. \
Аномальным значением является то, которое имеет отклонение от предсказанного значения в двое больше среднего отклонения
реального от предсказанного значения. \
Для выполнения прореживания необходимо выполнить следующую команду внутри контейнера ```power_graph_app```:

```
# Входим в контейнер
docker-compose exec app bash

# Выполняем команду:
./protected/yiic processolddata
```

Данная команда обращается к сервису ```DataThinningService```, подставляя при помощи Dependency Injection стратегии
выбора данных и период их выбора.

Стратегия реализовывает интерфейс ```IDataThinningStrategy``` и высчитывает линейную регрессию вместе с аномалиями при
помощи ```LinearRegressionCalculator```.

# Команды

В проекте присутствуют следующие пользовательские Yii команды:

1) Прореживание данные с поиском величин по линейной регрессии:

```
./protected/yiic processolddata
```

2) Генерация нового счётчика со случайным поминутным профилем:
   Параметр --days необязательный(стан. 1 день).

```
./protected/yiic seedvoltagedata --days=<количесво_дней>
```

# Проблемы

В проекте присутствуют следующие проблемы, которые на данный момент не решены:

1. Переполнение графика данными: \
   Если график получает слишком много данных, он перестаёт отображаться и выводит в консоль ошибку:

```
Uncaught DOMException: CanvasRenderingContext2D.resetTransform: Canvas is already in error state.
```

Возможные решения:

* Разделение данных на несколько графиков
* Переход на другую библиотеку для отрисовки графиков